// SillyTavern 上下文
const { getContext } = window;

// 模块名
const MODULE_NAME = 'phone-simulator';

// 创建面板
function createPanel() {
    // 面板
    const panel = document.createElement('div');
    panel.id = 'phone-panel';
    panel.className = 'phone-panel';
    panel.innerHTML = `
        <div class="phone-header">📱 我的小手机</div>
        <div class="phone-messages" id="phone-msgs"></div>
    `;
    document.body.appendChild(panel);

    // 开关按钮
    const btn = document.createElement('button');
    btn.className = 'phone-toggle';
    btn.innerText = '📱';
    btn.onclick = () => {
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    };
    document.body.appendChild(btn);

    // 简单拖拽
    let dragging = false, startX, startY;
    panel.addEventListener('mousedown', (e) => {
        dragging = true;
        startX = e.clientX - panel.getBoundingClientRect().left;
        startY = e.clientY - panel.getBoundingClientRect().top;
    });
    document.addEventListener('mousemove', (e) => {
        if (dragging) {
            panel.style.left = (e.clientX - startX) + 'px';
            panel.style.top = (e.clientY - startY) + 'px';
            panel.style.right = 'auto';
        }
    });
    document.addEventListener('mouseup', () => dragging = false);
}

// 更新消息
function updateMsgs() {
    const ctx = getContext();
    const msgsDiv = document.getElementById('phone-msgs');
    if (!msgsDiv || !ctx.chat) return;
    msgsDiv.innerHTML = '';
    ctx.chat.slice(-10).forEach(msg => {  // 只显示最近10条，避免卡
        const div = document.createElement('div');
        div.innerHTML = `<strong>${msg.name || 'AI'}:</strong> ${msg.mes}`;
        msgsDiv.appendChild(div);
    });
    msgsDiv.scrollTop = msgsDiv.scrollHeight;  // 自动滚到底
}

// 初始化
if (typeof getContext !== 'undefined') {
    createPanel();
    updateMsgs();

    // 监听新消息
    const ctx = getContext();
    const originalGenerate = ctx.generate;
    ctx.generate = function(...args) {
        return originalGenerate.apply(this, args).then(() => updateMsgs());
    };
}
}
