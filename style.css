// SillyTavern ä¸Šä¸‹æ–‡
const { getContext } = window;

// æ¨¡å—å
const MODULE_NAME = 'phone-simulator';

// åˆ›å»ºé¢æ¿
function createPanel() {
    // é¢æ¿
    const panel = document.createElement('div');
    panel.id = 'phone-panel';
    panel.className = 'phone-panel';
    panel.innerHTML = `
        <div class="phone-header">ğŸ“± æˆ‘çš„å°æ‰‹æœº</div>
        <div class="phone-messages" id="phone-msgs"></div>
    `;
    document.body.appendChild(panel);

    // å¼€å…³æŒ‰é’®
    const btn = document.createElement('button');
    btn.className = 'phone-toggle';
    btn.innerText = 'ğŸ“±';
    btn.onclick = () => {
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    };
    document.body.appendChild(btn);

    // ç®€å•æ‹–æ‹½
    let dragging = false, startX, startY;
    panel.addEventListener('mousedown', (e) => {
        dragging = true;
        startX = e.clientX - panel.getBoundingClientRect().left;
        startY = e.clientY - panel.getBoundingClientRect().top;
    });
    document.addEventListener('mousemove', (e) => {
        if (dragging) {
            panel.style.left = (e.clientX - startX) + 'px';
            panel.style.top = (e.clientY - startY) + 'px';
            panel.style.right = 'auto';
        }
    });
    document.addEventListener('mouseup', () => dragging = false);
}

// æ›´æ–°æ¶ˆæ¯
function updateMsgs() {
    const ctx = getContext();
    const msgsDiv = document.getElementById('phone-msgs');
    if (!msgsDiv || !ctx.chat) return;
    msgsDiv.innerHTML = '';
    ctx.chat.slice(-10).forEach(msg => {  // åªæ˜¾ç¤ºæœ€è¿‘10æ¡ï¼Œé¿å…å¡
        const div = document.createElement('div');
        div.innerHTML = `<strong>${msg.name || 'AI'}:</strong> ${msg.mes}`;
        msgsDiv.appendChild(div);
    });
    msgsDiv.scrollTop = msgsDiv.scrollHeight;  // è‡ªåŠ¨æ»šåˆ°åº•
}

// åˆå§‹åŒ–
if (typeof getContext !== 'undefined') {
    createPanel();
    updateMsgs();

    // ç›‘å¬æ–°æ¶ˆæ¯
    const ctx = getContext();
    const originalGenerate = ctx.generate;
    ctx.generate = function(...args) {
        return originalGenerate.apply(this, args).then(() => updateMsgs());
    };
}
}
